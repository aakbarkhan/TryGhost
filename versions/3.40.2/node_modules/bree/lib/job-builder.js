"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var _require = require('path'),
    join = _require.join;

var isSANB = require('is-string-and-not-blank');

var isValidPath = require('is-valid-path');

var _require2 = require('boolean'),
    boolean = _require2.boolean;

var later = require('@breejs/later');

var _require3 = require('./job-utils'),
    isSchedule = _require3.isSchedule,
    parseValue = _require3.parseValue; // eslint-disable-next-line complexity


var buildJob = function buildJob(job, config) {
  if (isSANB(job)) {
    var path = join(config.root, job.endsWith('.js') || job.endsWith('.mjs') ? job : "".concat(job, ".").concat(config.defaultExtension));
    return {
      name: job,
      path: path,
      timeout: config.timeout,
      interval: config.interval
    };
  }

  if (typeof job === 'function') {
    var _path = "(".concat(job.toString(), ")()");

    return {
      name: job.name,
      path: _path,
      worker: {
        eval: true
      },
      timeout: config.timeout,
      interval: config.interval
    };
  } // process job.path


  if (typeof job.path === 'function') {
    var _path2 = "(".concat(job.path.toString(), ")()");

    job.path = _path2;
    job.worker = _objectSpread({
      eval: true
    }, job.worker);
  } else {
    var _path3 = isSANB(job.path) ? job.path : join(config.root, job.name.endsWith('.js') || job.name.endsWith('.mjs') ? job.name : "".concat(job.name, ".").concat(config.defaultExtension));

    if (isValidPath(_path3)) {
      job.path = _path3;
    } else {
      // assume that it's a transformed eval string
      job.worker = _objectSpread({
        eval: true
      }, job.worker);
    }
  }

  if (typeof job.timeout !== 'undefined') {
    job.timeout = parseValue(job.timeout);
  }

  if (typeof job.interval !== 'undefined') {
    job.interval = parseValue(job.interval);
  } // build cron


  if (typeof job.cron !== 'undefined') {
    if (isSchedule(job.cron)) {
      job.interval = job.cron; // delete job.cron;
    } else {
      job.interval = later.parse.cron(job.cron, boolean(typeof job.hasSeconds === 'undefined' ? config.hasSeconds : job.hasSeconds));
    }
  } // if timeout was undefined, cron was undefined,
  // and date was undefined then set the default
  // (as long as the default timeout is >= 0)


  if (Number.isFinite(config.timeout) && config.timeout >= 0 && typeof job.timeout === 'undefined' && typeof job.cron === 'undefined' && typeof job.date === 'undefined' && typeof job.interval === 'undefined') job.timeout = config.timeout; // if interval was undefined, cron was undefined,
  // and date was undefined then set the default
  // (as long as the default interval is > 0, or it was a schedule, or it was valid)

  if ((Number.isFinite(config.interval) && config.interval > 0 || isSchedule(config.interval)) && typeof job.interval === 'undefined' && typeof job.cron === 'undefined' && typeof job.date === 'undefined') job.interval = config.interval;
  return job;
};

module.exports = buildJob;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9qb2ItYnVpbGRlci5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiam9pbiIsImlzU0FOQiIsImlzVmFsaWRQYXRoIiwiYm9vbGVhbiIsImxhdGVyIiwiaXNTY2hlZHVsZSIsInBhcnNlVmFsdWUiLCJidWlsZEpvYiIsImpvYiIsImNvbmZpZyIsInBhdGgiLCJyb290IiwiZW5kc1dpdGgiLCJkZWZhdWx0RXh0ZW5zaW9uIiwibmFtZSIsInRpbWVvdXQiLCJpbnRlcnZhbCIsInRvU3RyaW5nIiwid29ya2VyIiwiZXZhbCIsImNyb24iLCJwYXJzZSIsImhhc1NlY29uZHMiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsImRhdGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O2VBQWlCQSxPQUFPLENBQUMsTUFBRCxDO0lBQWhCQyxJLFlBQUFBLEk7O0FBQ1IsSUFBTUMsTUFBTSxHQUFHRixPQUFPLENBQUMseUJBQUQsQ0FBdEI7O0FBQ0EsSUFBTUcsV0FBVyxHQUFHSCxPQUFPLENBQUMsZUFBRCxDQUEzQjs7Z0JBQ29CQSxPQUFPLENBQUMsU0FBRCxDO0lBQW5CSSxPLGFBQUFBLE87O0FBQ1IsSUFBTUMsS0FBSyxHQUFHTCxPQUFPLENBQUMsZUFBRCxDQUFyQjs7Z0JBQ21DQSxPQUFPLENBQUMsYUFBRCxDO0lBQWxDTSxVLGFBQUFBLFU7SUFBWUMsVSxhQUFBQSxVLEVBRXBCOzs7QUFDQSxJQUFNQyxRQUFRLEdBQUcsU0FBWEEsUUFBVyxDQUFDQyxHQUFELEVBQU1DLE1BQU4sRUFBaUI7QUFDaEMsTUFBSVIsTUFBTSxDQUFDTyxHQUFELENBQVYsRUFBaUI7QUFDZixRQUFNRSxJQUFJLEdBQUdWLElBQUksQ0FDZlMsTUFBTSxDQUFDRSxJQURRLEVBRWZILEdBQUcsQ0FBQ0ksUUFBSixDQUFhLEtBQWIsS0FBdUJKLEdBQUcsQ0FBQ0ksUUFBSixDQUFhLE1BQWIsQ0FBdkIsR0FDSUosR0FESixhQUVPQSxHQUZQLGNBRWNDLE1BQU0s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QUFNLENBQUNhLFVBRFgsR0FFSWQsR0FBRyxDQUFDYyxVQUhILENBRk0sQ0FBZjtBQVFEO0FBQ0YsR0FsRitCLENBb0ZoQztBQUNBO0FBQ0E7OztBQUNBLE1BQ0VDLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQmYsTUFBTSxDQUFDTSxPQUF2QixLQUNBTixNQUFNLENBQUNNLE9BQVAsSUFBa0IsQ0FEbEIsSUFFQSxPQUFPUCxHQUFHLENBQUNPLE9BQVgsS0FBdUIsV0FGdkIsSUFHQSxPQUFPUCxHQUFHLENBQUNZLElBQVgsS0FBb0IsV0FIcEIsSUFJQSxPQUFPWixHQUFHLENBQUNpQixJQUFYLEtBQW9CLFdBSnBCLElBS0EsT0FBT2pCLEdBQUcsQ0FBQ1EsUUFBWCxLQUF3QixXQU4xQixFQVFFUixHQUFHLENBQUNPLE9BQUosR0FBY04sTUFBTSxDQUFDTSxPQUFyQixDQS9GOEIsQ0FpR2hDO0FBQ0E7QUFDQTs7QUFDQSxNQUNFLENBQUVRLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQmYsTUFBTSxDQUFDTyxRQUF2QixLQUFvQ1AsTUFBTSxDQUFDTyxRQUFQLEdBQWtCLENBQXZELElBQ0NYLFVBQVUsQ0FBQ0ksTUFBTSxDQUFDTyxRQUFSLENBRFosS0FFQSxPQUFPUixHQUFHLENBQUNRLFFBQVgsS0FBd0IsV0FGeEIsSUFHQSxPQUFPUixHQUFHLENBQUNZLElBQVgsS0FBb0IsV0FIcEIsSUFJQSxPQUFPWixHQUFHLENBQUNpQixJQUFYLEtBQW9CLFdBTHRCLEVBT0VqQixHQUFHLENBQUNRLFFBQUosR0FBZVAsTUFBTSxDQUFDTyxRQUF0QjtBQUVGLFNBQU9SLEdBQVA7QUFDRCxDQTlHRDs7QUFnSEFrQixNQUFNLENBQUNDLE9BQVAsR0FBaUJwQixRQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgam9pbiB9ID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgaXNTQU5CID0gcmVxdWlyZSgnaXMtc3RyaW5nLWFuZC1ub3QtYmxhbmsnKTtcbmNvbnN0IGlzVmFsaWRQYXRoID0gcmVxdWlyZSgnaXMtdmFsaWQtcGF0aCcpO1xuY29uc3QgeyBib29sZWFuIH0gPSByZXF1aXJlKCdib29sZWFuJyk7XG5jb25zdCBsYXRlciA9IHJlcXVpcmUoJ0BicmVlanMvbGF0ZXInKTtcbmNvbnN0IHsgaXNTY2hlZHVsZSwgcGFyc2VWYWx1ZSB9ID0gcmVxdWlyZSgnLi9qb2ItdXRpbHMnKTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBsZXhpdHlcbmNvbnN0IGJ1aWxkSm9iID0gKGpvYiwgY29uZmlnKSA9PiB7XG4gIGlmIChpc1NBTkIoam9iKSkge1xuICAgIGNvbnN0IHBhdGggPSBqb2luKFxuICAgICAgY29uZmlnLnJvb3QsXG4gICAgICBqb2IuZW5kc1dpdGgoJy5qcycpIHx8IGpvYi5lbmRzV2l0aCgnLm1qcycpXG4gICAgICAgID8gam9iXG4gICAgICAgIDogYCR7am9ifS4ke2NvbmZpZy5kZWZhdWx0RXh0ZW5zaW9ufWBcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IGpvYixcbiAgICAgIHBhdGgsXG4gICAgICB0aW1lb3V0OiBjb25maWcudGltZW91dCxcbiAgICAgIGludGVydmFsOiBjb25maWcuaW50ZXJ2YWxcbiAgICB9O1xuICB9XG5cbiAgaWYgKHR5cGVvZiBqb2IgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBwYXRoID0gYCgke2pvYi50b1N0cmluZygpfSkoKWA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogam9iLm5hbWUsXG4gICAgICBwYXRoLFxuICAgICAgd29ya2VyOiB7IGV2YWw6IHRydWUgfSxcbiAgICAgIHRpbWVvdXQ6IGNvbmZpZy50aW1lb3V0LFxuICAgICAgaW50ZXJ2YWw6IGNvbmZpZy5pbnRlcnZhbFxuICAgIH07XG4gIH1cblxuICAvLyBwcm9jZXNzIGpvYi5wYXRoXG4gIGlmICh0eXBlb2Ygam9iLnBhdGggPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBwYXRoID0gYCgke2pvYi5wYXRoLnRvU3RyaW5nKCl9KSgpYDtcblxuICAgIGpvYi5wYXRoID0gcGF0aDtcbiAgICBqb2Iud29ya2VyID0ge1xuICAgICAgZXZhbDogdHJ1ZSxcbiAgICAgIC4uLmpvYi53b3JrZXJcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHBhdGggPSBpc1NBTkIoam9iLnBhdGgpXG4gICAgICA/IGpvYi5wYXRoXG4gICAgICA6IGpvaW4oXG4gICAgICAgICAgY29uZmlnLnJvb3QsXG4gICAgICAgICAgam9iLm5hbWUuZW5kc1dpdGgoJy5qcycpIHx8IGpvYi5uYW1lLmVuZHNXaXRoKCcubWpzJylcbiAgICAgICAgICAgID8gam9iLm5hbWVcbiAgICAgICAgICAgIDogYCR7am9iLm5hbWV9LiR7Y29uZmlnLmRlZmF1bHRFeHRlbnNpb259YFxuICAgICAgICApO1xuXG4gICAgaWYgKGlzVmFsaWRQYXRoKHBhdGgpKSB7XG4gICAgICBqb2IucGF0aCA9IHBhdGg7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGFzc3VtZSB0aGF0IGl0J3MgYSB0cmFuc2Zvcm1lZCBldmFsIHN0cmluZ1xuICAgICAgam9iLndvcmtlciA9IHtcbiAgICAgICAgZXZhbDogdHJ1ZSxcbiAgICAgICAgLi4uam9iLndvcmtlclxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBpZiAodHlwZW9mIGpvYi50aW1lb3V0ICE9PSAndW5kZWZpbmVkJykge1xuICAgIGpvYi50aW1lb3V0ID0gcGFyc2VWYWx1ZShqb2IudGltZW91dCk7XG4gIH1cblxuICBpZiAodHlwZW9mIGpvYi5pbnRlcnZhbCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBqb2IuaW50ZXJ2YWwgPSBwYXJzZVZhbHVlKGpvYi5pbnRlcnZhbCk7XG4gIH1cblxuICAvLyBidWlsZCBjcm9uXG4gIGlmICh0eXBlb2Ygam9iLmNyb24gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgaWYgKGlzU2NoZWR1bGUoam9iLmNyb24pKSB7XG4gICAgICBqb2IuaW50ZXJ2YWwgPSBqb2IuY3JvbjtcbiAgICAgIC8vIGRlbGV0ZSBqb2IuY3JvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgam9iLmludGVydmFsID0gbGF0ZXIucGFyc2UuY3JvbihcbiAgICAgICAgam9iLmNyb24sXG4gICAgICAgIGJvb2xlYW4oXG4gICAgICAgICAgdHlwZW9mIGpvYi5oYXNTZWNvbmRzID09PSAndW5kZWZpbmVkJ1xuICAgICAgICAgICAgPyBjb25maWcuaGFzU2Vjb25kc1xuICAgICAgICAgICAgOiBqb2IuaGFzU2Vjb25kc1xuICAgICAgICApXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIGlmIHRpbWVvdXQgd2FzIHVuZGVmaW5lZCwgY3JvbiB3YXMgdW5kZWZpbmVkLFxuICAvLyBhbmQgZGF0ZSB3YXMgdW5kZWZpbmVkIHRoZW4gc2V0IHRoZSBkZWZhdWx0XG4gIC8vIChhcyBsb25nIGFzIHRoZSBkZWZhdWx0IHRpbWVvdXQgaXMgPj0gMClcbiAgaWYgKFxuICAgIE51bWJlci5pc0Zpbml0ZShjb25maWcudGltZW91dCkgJiZcbiAgICBjb25maWcudGltZW91dCA+PSAwICYmXG4gICAgdHlwZW9mIGpvYi50aW1lb3V0ID09PSAndW5kZWZpbmVkJyAmJlxuICAgIHR5cGVvZiBqb2IuY3JvbiA9PT0gJ3VuZGVmaW5lZCcgJiZcbiAgICB0eXBlb2Ygam9iLmRhdGUgPT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIGpvYi5pbnRlcnZhbCA9PT0gJ3VuZGVmaW5lZCdcbiAgKVxuICAgIGpvYi50aW1lb3V0ID0gY29uZmlnLnRpbWVvdXQ7XG5cbiAgLy8gaWYgaW50ZXJ2YWwgd2FzIHVuZGVmaW5lZCwgY3JvbiB3YXMgdW5kZWZpbmVkLFxuICAvLyBhbmQgZGF0ZSB3YXMgdW5kZWZpbmVkIHRoZW4gc2V0IHRoZSBkZWZhdWx0XG4gIC8vIChhcyBsb25nIGFzIHRoZSBkZWZhdWx0IGludGVydmFsIGlzID4gMCwgb3IgaXQgd2FzIGEgc2NoZWR1bGUsIG9yIGl0IHdhcyB2YWxpZClcbiAgaWYgKFxuICAgICgoTnVtYmVyLmlzRmluaXRlKGNvbmZpZy5pbnRlcnZhbCkgJiYgY29uZmlnLmludGVydmFsID4gMCkgfHxcbiAgICAgIGlzU2NoZWR1bGUoY29uZmlnLmludGVydmFsKSkgJiZcbiAgICB0eXBlb2Ygam9iLmludGVydmFsID09PSAndW5kZWZpbmVkJyAmJlxuICAgIHR5cGVvZiBqb2IuY3JvbiA9PT0gJ3VuZGVmaW5lZCcgJiZcbiAgICB0eXBlb2Ygam9iLmRhdGUgPT09ICd1bmRlZmluZWQnXG4gIClcbiAgICBqb2IuaW50ZXJ2YWwgPSBjb25maWcuaW50ZXJ2YWw7XG5cbiAgcmV0dXJuIGpvYjtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gYnVpbGRKb2I7XG4iXX0=