"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

function _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === "undefined" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var fs = require('fs');

var _require = require('path'),
    join = _require.join;

var combineErrors = require('combine-errors');

var cron = require('cron-validate');

var isSANB = require('is-string-and-not-blank');

var isValidPath = require('is-valid-path');

var threads = require('bthreads');

var _require2 = require('./job-utils'),
    getName = _require2.getName,
    isSchedule = _require2.isSchedule,
    parseValue = _require2.parseValue;

var validateReservedJobName = function validateReservedJobName(name) {
  // don't allow a job to have the `index` file name
  if (['index', 'index.js', 'index.mjs'].includes(name)) return new Error('You cannot use the reserved job name of "index", "index.js", nor "index.mjs"');
};

var validateStringJob = function validateStringJob(job, i, config) {
  var errors = [];
  var jobNameError = validateReservedJobName(job);
  if (jobNameError) throw jobNameError;

  if (!config.root) {
    errors.push(new Error("Job #".concat(i + 1, " \"").concat(job, "\" requires root directory option to auto-populate path")));
    throw combineErrors(errors);
  }

  var path = join(config.root, job.endsWith('.js') || job.endsWith('.mjs') ? job : "".concat(job, ".").concat(config.defaultExtension));
  /* istanbul ignore next */

  if (!threads.browser) {
    var stats = fs.statSync(path);
    if (!stats.isFile()) throw new Error("Job #".concat(i + 1, " \"").concat(job, "\" path missing: ").concat(path));
  }
};

var validateFunctionJob = function validateFunctionJob(job, i) {
  var errors = [];
  var path = "(".concat(job.toString(), ")()"); // can't be a built-in or bound function

  if (path.includes('[native code]')) errors.push(new Error("Job #".concat(i + 1, " can't be a bound or built-in function")));
  if (errors.length > 0) throw combineErrors(errors);
};

var validateJobPath = function validateJobPath(job, prefix, config) {
  var errors = [];

  if (typeof job.path === 'function') {
    var path = "(".concat(job.path.toString(), ")()"); // can't be a built-in or bound function

    if (path.includes('[native code]')) errors.push(new Error("".concat(prefix, " can't be a bound or built-in function")));
  } else if (!isSANB(job.path) && !config.root) {
    errors.push(new Error("".concat(prefix, " requires root directory option to auto-populate path")));
  } else {
    // validate path
    var _path = isSANB(job.path) ? job.path : join(config.root, job.name.endsWith('.js') || job.name.endsWith('.mjs') ? job.name : "".concat(job.name, ".").concat(config.defaultExtension));

    if (isValidPath(_path)) {
      try {
        /* istanbul ignore next */
        if (!threads.browser) {
          var stats = fs.statSync(_path); // eslint-disable-next-line max-depth

          if (!stats.isFile()) throw new Error("".concat(prefix, " path missing: ").concat(_path));
        }
      } catch (err) {
        errors.push(err);
      }
    }
  }

  return errors;
};

var cronValidateWithSeconds = function cronValidateWithSeconds(job, config) {
  var preset = job.cronValidate && job.cronValidate.preset ? job.cronValidate.preset : config.cronValidate && config.cronValidate.preset ? config.cronValidate.preset : 'default';

  var override = _objectSpread(_objectSpread(_objectSpread({}, config.cronValidate && config.cronValidate.override ? config.cronValidate.override : {}), job.cronValidate && job.cronValidate.override ? job.cronValidate.override : {}), {}, {
    useSeconds: true
  });

  return _objectSpread(_objectSpread(_objectSpread({}, config.cronValidate), job.cronValidate), {}, {
    preset: preset,
    override: override
  });
};

var validateCron = function validateCron(job, prefix, config) {
  var errors = [];

  if (!isSchedule(job.cron)) {
    // if `hasSeconds` was `true` then set `cronValidate` and inherit any existing options
    var cronValidate = job.hasSeconds ? cronValidateWithSeconds(job, config) : config.cronValidate; //
    // validate cron pattern
    // (must support patterns such as `* * L * *` and `0 0/5 14 * * ?` (and aliases too)
    //
    //  <https://github.com/Airfooox/cron-validate/issues/67>
    //

    var result = cron(job.cron, cronValidate);

    if (!result.isValid()) {
      // NOTE: it is always valid
      // const schedule = later.schedule(
      //   later.parse.cron(
      //     job.cron,
      //     boolean(
      //       typeof job.hasSeconds === 'undefined'
      //         ? config.hasSeconds
      //         : job.hasSeconds
      //     )
      //   )
      // );
      // if (schedule.isValid()) {
      //   job.interval = schedule;
      // } // else {
      //   errors.push(
      //     new Error(
      //       `${prefix} had an invalid cron schedule (see <https://crontab.guru> if you need help)`
      //     )
      //   );
      // }
      var _iterator = _createForOfIteratorHelper(result.getError()),
          _step;

      try {
        for (_iterator.s(); !(_step = _iterator.n()).done;) {
          var message = _step.value;
          errors.push(new Error("".concat(prefix, " had an invalid cron pattern: ").concat(message)));
        }
      } catch (err) {
        _iterator.e(err);
      } finally {
        _iterator.f();
      }
    }
  }

  return errors;
};

var validateJobName = function validateJobName(job, i, reservedNames) {
  var errors = [];
  var name = getName(job);
  if (!name) errors.push(new Error("Job #".concat(i + 1, " is missing a name"))); // throw an error if duplicate job names

  if (reservedNames.includes(name)) {
    errors.push(new Error("Job #".concat(i + 1, " has a duplicate job name of ").concat(getName(job))));
  }

  return errors;
};

var validate = function validate(job, i, names, config) {
  var errors = validateJobName(job, i, names);
  if (errors.length > 0) throw combineErrors(errors); // support a simple string which we will transform to have a path

  if (isSANB(job)) {
    return validateStringJob(job, i, config);
  } // job is a function


  if (typeof job === 'function') {
    return validateFunctionJob(job, i);
  } // use a prefix for errors


  var prefix = "Job #".concat(i + 1, " named \"").concat(job.name, "\"");
  errors.push.apply(errors, (0, _toConsumableArray2.default)(validateJobPath(job, prefix, config))); // don't allow users to mix interval AND cron

  if (typeof job.interval !== 'undefined' && typeof job.cron !== 'undefined') {
    errors.push(new Error("".concat(prefix, " cannot have both interval and cron configuration")));
  } // don't allow users to mix timeout AND date


  if (typeof job.timeout !== 'undefined' && typeof job.date !== 'undefined') errors.push(new Error("".concat(prefix, " cannot have both timeout and date")));
  var jobNameError = validateReservedJobName(job.name);
  if (jobNameError) errors.push(jobNameError); // validate date

  if (typeof job.date !== 'undefined' && !(job.date instanceof Date)) errors.push(new Error("".concat(prefix, " had an invalid Date of ").concat(job.date)));
  ['timeout', 'interval'].forEach(function (prop) {
    if (typeof job[prop] !== 'undefined') {
      try {
        parseValue(job[prop]);
      } catch (err) {
        errors.push(combineErrors([new Error("".concat(prefix, " had an invalid ").concat(prop, " of ").concat(job.timeout)), err]));
      }
    }
  }); // validate hasSeconds

  if (typeof job.hasSeconds !== 'undefined' && typeof job.hasSeconds !== 'boolean') errors.push(new Error("".concat(prefix, " had hasSeconds value of ").concat(job.hasSeconds, " (it must be a Boolean)"))); // validate cronValidate

  if (typeof job.cronValidate !== 'undefined' && (0, _typeof2.default)(job.cronValidate) !== 'object') errors.push(new Error("".concat(prefix, " had cronValidate value set, but it must be an Object")));

  if (typeof job.cron !== 'undefined') {
    errors.push.apply(errors, (0, _toConsumableArray2.default)(validateCron(job, prefix, config)));
  } // validate closeWorkerAfterMs


  if (typeof job.closeWorkerAfterMs !== 'undefined' && (!Number.isFinite(job.closeWorkerAfterMs) || job.closeWorkerAfterMs <= 0)) errors.push(new Error("".concat(prefix, " had an invalid closeWorkersAfterMs value of ").concat(job.closeWorkersAfterMs, " (it must be a finite number > 0)")));
  if (errors.length > 0) throw combineErrors(errors);
};

module.exports = validate;
module.exports.cronValidateWithSeconds = cronValidateWithSeconds;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9qb2ItdmFsaWRhdG9yLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsImpvaW4iLCJjb21iaW5lRXJyb3JzIiwiY3JvbiIsImlzU0FOQiIsImlzVmFsaWRQYXRoIiwidGhyZWFkcyIsImdldE5hbWUiLCJpc1NjaGVkdWxlIiwicGFyc2VWYWx1ZSIsInZhbGlkYXRlUmVzZXJ2ZWRKb2JOYW1lIiwibmFtZSIsImluY2x1ZGVzIiwiRXJyb3IiLCJ2YWxpZGF0ZVN0cmluZ0pvYiIsImpvYiIsImkiLCJjb25maWciLCJlcnJvcnMiLCJqb2JOYW1lRXJyb3IiLCJyb290IiwicHVzaCIsInBhdGgiLCJlbmRzV2l0aCIsImRlZmF1bHRFeHRlbnNpb24iLCJicm93c2VyIiwic3RhdHMiLCJzdGF0U3luYyIsImlzRmlsZSIsInZhbGlkYXRlRnVuY3Rpb25Kb2IiLCJ0b1N0cmluZyIsImxlbmd0aCIsInZhbGlkYXRlSm9iUGF0aCIsInByZWZpeCIsImVyciIsImNyb25WYWxpZGF0ZVdpdGhTZWNvbmRzIiwicHJlc2V0IiwiY3JvblZhbGlkYXRlIiwib3ZlcnJpZGUiLCJ1c2VTZWNvbmRzIiwidmFsaWRhdGVDcm9uIiwiaGFzU2Vjb25kcyIsInJlc3VsdCIsImlzVmFsaWQiLCJnZXRFcnJvciIsIm1lc3NhZ2UiLCJ2YWxpZGF0ZUpvYk5hbWUiLCJyZXNlcnZlZE5hbWVzIiwidmFsaWRhdGUiLCJuYW1lcyIsImludGVydmFsIiwidGltZW91dCIsImRhdGUiLCJEYXRlIiwiZm9yRWFjaCIsInByb3AiLCJjbG9zZVdvcmtlckFmdGVyTXMiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsImNsb3NlV29ya2Vyc0FmdGVyTXMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O2VBQ2lCQSxPQUFPLENBQUMsTUFBRCxDO0lBQWhCQyxJLFlBQUFBLEk7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QkFBekMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCB7IGpvaW4gfSA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGNvbWJpbmVFcnJvcnMgPSByZXF1aXJlKCdjb21iaW5lLWVycm9ycycpO1xuY29uc3QgY3JvbiA9IHJlcXVpcmUoJ2Nyb24tdmFsaWRhdGUnKTtcbmNvbnN0IGlzU0FOQiA9IHJlcXVpcmUoJ2lzLXN0cmluZy1hbmQtbm90LWJsYW5rJyk7XG5jb25zdCBpc1ZhbGlkUGF0aCA9IHJlcXVpcmUoJ2lzLXZhbGlkLXBhdGgnKTtcbmNvbnN0IHRocmVhZHMgPSByZXF1aXJlKCdidGhyZWFkcycpO1xuXG5jb25zdCB7IGdldE5hbWUsIGlzU2NoZWR1bGUsIHBhcnNlVmFsdWUgfSA9IHJlcXVpcmUoJy4vam9iLXV0aWxzJyk7XG5cbmNvbnN0IHZhbGlkYXRlUmVzZXJ2ZWRKb2JOYW1lID0gKG5hbWUpID0+IHtcbiAgLy8gZG9uJ3QgYWxsb3cgYSBqb2IgdG8gaGF2ZSB0aGUgYGluZGV4YCBmaWxlIG5hbWVcbiAgaWYgKFsnaW5kZXgnLCAnaW5kZXguanMnLCAnaW5kZXgubWpzJ10uaW5jbHVkZXMobmFtZSkpXG4gICAgcmV0dXJuIG5ldyBFcnJvcihcbiAgICAgICdZb3UgY2Fubm90IHVzZSB0aGUgcmVzZXJ2ZWQgam9iIG5hbWUgb2YgXCJpbmRleFwiLCBcImluZGV4LmpzXCIsIG5vciBcImluZGV4Lm1qc1wiJ1xuICAgICk7XG59O1xuXG5jb25zdCB2YWxpZGF0ZVN0cmluZ0pvYiA9IChqb2IsIGksIGNvbmZpZykgPT4ge1xuICBjb25zdCBlcnJvcnMgPSBbXTtcblxuICBjb25zdCBqb2JOYW1lRXJyb3IgPSB2YWxpZGF0ZVJlc2VydmVkSm9iTmFtZShqb2IpO1xuICBpZiAoam9iTmFtZUVycm9yKSB0aHJvdyBqb2JOYW1lRXJyb3I7XG5cbiAgaWYgKCFjb25maWcucm9vdCkge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgbmV3IEVycm9yKFxuICAgICAgICBgSm9iICMke1xuICAgICAgICAgIGkgKyAxXG4gICAgICAgIH0gXCIke2pvYn1cIiByZXF1aXJlcyByb290IGRpcmVjdG9yeSBvcHRpb24gdG8gYXV0by1wb3B1bGF0ZSBwYXRoYFxuICAgICAgKVxuICAgICk7XG4gICAgdGhyb3cgY29tYmluZUVycm9ycyhlcnJvcnMpO1xuICB9XG5cbiAgY29uc3QgcGF0aCA9IGpvaW4oXG4gICAgY29uZmlnLnJvb3QsXG4gICAgam9iLmVuZHNXaXRoKCcuanMnKSB8fCBqb2IuZW5kc1dpdGgoJy5tanMnKVxuICAgICAgPyBqb2JcbiAgICAgIDogYCR7am9ifS4ke2NvbmZpZy5kZWZhdWx0RXh0ZW5zaW9ufWBcbiAgKTtcblxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICBpZiAoIXRocmVhZHMuYnJvd3Nlcikge1xuICAgIGNvbnN0IHN0YXRzID0gZnMuc3RhdFN5bmMocGF0aCk7XG4gICAgaWYgKCFzdGF0cy5pc0ZpbGUoKSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSm9iICMke2kgKyAxfSBcIiR7am9ifVwiIHBhdGggbWlzc2luZzogJHtwYXRofWApO1xuICB9XG59O1xuXG5jb25zdCB2YWxpZGF0ZUZ1bmN0aW9uSm9iID0gKGpvYiwgaSkgPT4ge1xuICBjb25zdCBlcnJvcnMgPSBbXTtcblxuICBjb25zdCBwYXRoID0gYCgke2pvYi50b1N0cmluZygpfSkoKWA7XG4gIC8vIGNhbid0IGJlIGEgYnVpbHQtaW4gb3IgYm91bmQgZnVuY3Rpb25cbiAgaWYgKHBhdGguaW5jbHVkZXMoJ1tuYXRpdmUgY29kZV0nKSlcbiAgICBlcnJvcnMucHVzaChcbiAgICAgIG5ldyBFcnJvcihgSm9iICMke2kgKyAxfSBjYW4ndCBiZSBhIGJvdW5kIG9yIGJ1aWx0LWluIGZ1bmN0aW9uYClcbiAgICApO1xuXG4gIGlmIChlcnJvcnMubGVuZ3RoID4gMCkgdGhyb3cgY29tYmluZUVycm9ycyhlcnJvcnMpO1xufTtcblxuY29uc3QgdmFsaWRhdGVKb2JQYXRoID0gKGpvYiwgcHJlZml4LCBjb25maWcpID0+IHtcbiAgY29uc3QgZXJyb3JzID0gW107XG5cbiAgaWYgKHR5cGVvZiBqb2IucGF0aCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGNvbnN0IHBhdGggPSBgKCR7am9iLnBhdGgudG9TdHJpbmcoKX0pKClgO1xuXG4gICAgLy8gY2FuJ3QgYmUgYSBidWlsdC1pbiBvciBib3VuZCBmdW5jdGlvblxuICAgIGlmIChwYXRoLmluY2x1ZGVzKCdbbmF0aXZlIGNvZGVdJykpXG4gICAgICBlcnJvcnMucHVzaChuZXcgRXJyb3IoYCR7cHJlZml4fSBjYW4ndCBiZSBhIGJvdW5kIG9yIGJ1aWx0LWluIGZ1bmN0aW9uYCkpO1xuICB9IGVsc2UgaWYgKCFpc1NBTkIoam9iLnBhdGgpICYmICFjb25maWcucm9vdCkge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgbmV3IEVycm9yKFxuICAgICAgICBgJHtwcmVmaXh9IHJlcXVpcmVzIHJvb3QgZGlyZWN0b3J5IG9wdGlvbiB0byBhdXRvLXBvcHVsYXRlIHBhdGhgXG4gICAgICApXG4gICAgKTtcbiAgfSBlbHNlIHtcbiAgICAvLyB2YWxpZGF0ZSBwYXRoXG4gICAgY29uc3QgcGF0aCA9IGlzU0FOQihqb2IucGF0aClcbiAgICAgID8gam9iLnBhdGhcbiAgICAgIDogam9pbihcbiAgICAgICAgICBjb25maWcucm9vdCxcbiAgICAgICAgICBqb2IubmFtZS5lbmRzV2l0aCgnLmpzJykgfHwgam9iLm5hbWUuZW5kc1dpdGgoJy5tanMnKVxuICAgICAgICAgICAgPyBqb2IubmFtZVxuICAgICAgICAgICAgOiBgJHtqb2IubmFtZX0uJHtjb25maWcuZGVmYXVsdEV4dGVuc2lvbn1gXG4gICAgICAgICk7XG4gICAgaWYgKGlzVmFsaWRQYXRoKHBhdGgpKSB7XG4gICAgICB0cnkge1xuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgICAgICBpZiAoIXRocmVhZHMuYnJvd3Nlcikge1xuICAgICAgICAgIGNvbnN0IHN0YXRzID0gZnMuc3RhdFN5bmMocGF0aCk7XG4gICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1kZXB0aFxuICAgICAgICAgIGlmICghc3RhdHMuaXNGaWxlKCkpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7cHJlZml4fSBwYXRoIG1pc3Npbmc6ICR7cGF0aH1gKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGVycik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGVycm9ycztcbn07XG5cbmNvbnN0IGNyb25WYWxpZGF0ZVdpdGhTZWNvbmRzID0gKGpvYiwgY29uZmlnKSA9PiB7XG4gIGNvbnN0IHByZXNldCA9XG4gICAgam9iLmNyb25WYWxpZGF0ZSAmJiBqb2IuY3JvblZhbGlkYXRlLnByZXNldFxuICAgICAgPyBqb2IuY3JvblZhbGlkYXRlLnByZXNldFxuICAgICAgOiBjb25maWcuY3JvblZhbGlkYXRlICYmIGNvbmZpZy5jcm9uVmFsaWRhdGUucHJlc2V0XG4gICAgICA/IGNvbmZpZy5jcm9uVmFsaWRhdGUucHJlc2V0XG4gICAgICA6ICdkZWZhdWx0JztcbiAgY29uc3Qgb3ZlcnJpZGUgPSB7XG4gICAgLi4uKGNvbmZpZy5jcm9uVmFsaWRhdGUgJiYgY29uZmlnLmNyb25WYWxpZGF0ZS5vdmVycmlkZVxuICAgICAgPyBjb25maWcuY3JvblZhbGlkYXRlLm92ZXJyaWRlXG4gICAgICA6IHt9KSxcbiAgICAuLi4oam9iLmNyb25WYWxpZGF0ZSAmJiBqb2IuY3JvblZhbGlkYXRlLm92ZXJyaWRlXG4gICAgICA/IGpvYi5jcm9uVmFsaWRhdGUub3ZlcnJpZGVcbiAgICAgIDoge30pLFxuICAgIHVzZVNlY29uZHM6IHRydWVcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIC4uLmNvbmZpZy5jcm9uVmFsaWRhdGUsXG4gICAgLi4uam9iLmNyb25WYWxpZGF0ZSxcbiAgICBwcmVzZXQsXG4gICAgb3ZlcnJpZGVcbiAgfTtcbn07XG5cbmNvbnN0IHZhbGlkYXRlQ3JvbiA9IChqb2IsIHByZWZpeCwgY29uZmlnKSA9PiB7XG4gIGNvbnN0IGVycm9ycyA9IFtdO1xuXG4gIGlmICghaXNTY2hlZHVsZShqb2IuY3JvbikpIHtcbiAgICAvLyBpZiBgaGFzU2Vjb25kc2Agd2FzIGB0cnVlYCB0aGVuIHNldCBgY3JvblZhbGlkYXRlYCBhbmQgaW5oZXJpdCBhbnkgZXhpc3Rpbmcgb3B0aW9uc1xuICAgIGNvbnN0IGNyb25WYWxpZGF0ZSA9IGpvYi5oYXNTZWNvbmRzXG4gICAgICA/IGNyb25WYWxpZGF0ZVdpdGhTZWNvbmRzKGpvYiwgY29uZmlnKVxuICAgICAgOiBjb25maWcuY3JvblZhbGlkYXRlO1xuXG4gICAgLy9cbiAgICAvLyB2YWxpZGF0ZSBjcm9uIHBhdHRlcm5cbiAgICAvLyAobXVzdCBzdXBwb3J0IHBhdHRlcm5zIHN1Y2ggYXMgYCogKiBMICogKmAgYW5kIGAwIDAvNSAxNCAqICogP2AgKGFuZCBhbGlhc2VzIHRvbylcbiAgICAvL1xuICAgIC8vICA8aHR0cHM6Ly9naXRodWIuY29tL0FpcmZvb294L2Nyb24tdmFsaWRhdGUvaXNzdWVzLzY3PlxuICAgIC8vXG4gICAgY29uc3QgcmVzdWx0ID0gY3Jvbihqb2IuY3JvbiwgY3JvblZhbGlkYXRlKTtcblxuICAgIGlmICghcmVzdWx0LmlzVmFsaWQoKSkge1xuICAgICAgLy8gTk9URTogaXQgaXMgYWx3YXlzIHZhbGlkXG4gICAgICAvLyBjb25zdCBzY2hlZHVsZSA9IGxhdGVyLnNjaGVkdWxlKFxuICAgICAgLy8gICBsYXRlci5wYXJzZS5jcm9uKFxuICAgICAgLy8gICAgIGpvYi5jcm9uLFxuICAgICAgLy8gICAgIGJvb2xlYW4oXG4gICAgICAvLyAgICAgICB0eXBlb2Ygam9iLmhhc1NlY29uZHMgPT09ICd1bmRlZmluZWQnXG4gICAgICAvLyAgICAgICAgID8gY29uZmlnLmhhc1NlY29uZHNcbiAgICAgIC8vICAgICAgICAgOiBqb2IuaGFzU2Vjb25kc1xuICAgICAgLy8gICAgIClcbiAgICAgIC8vICAgKVxuICAgICAgLy8gKTtcbiAgICAgIC8vIGlmIChzY2hlZHVsZS5pc1ZhbGlkKCkpIHtcbiAgICAgIC8vICAgam9iLmludGVydmFsID0gc2NoZWR1bGU7XG4gICAgICAvLyB9IC8vIGVsc2Uge1xuICAgICAgLy8gICBlcnJvcnMucHVzaChcbiAgICAgIC8vICAgICBuZXcgRXJyb3IoXG4gICAgICAvLyAgICAgICBgJHtwcmVmaXh9IGhhZCBhbiBpbnZhbGlkIGNyb24gc2NoZWR1bGUgKHNlZSA8aHR0cHM6Ly9jcm9udGFiLmd1cnU+IGlmIHlvdSBuZWVkIGhlbHApYFxuICAgICAgLy8gICAgIClcbiAgICAgIC8vICAgKTtcbiAgICAgIC8vIH1cblxuICAgICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIHJlc3VsdC5nZXRFcnJvcigpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgIG5ldyBFcnJvcihgJHtwcmVmaXh9IGhhZCBhbiBpbnZhbGlkIGNyb24gcGF0dGVybjogJHttZXNzYWdlfWApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGVycm9ycztcbn07XG5cbmNvbnN0IHZhbGlkYXRlSm9iTmFtZSA9IChqb2IsIGksIHJlc2VydmVkTmFtZXMpID0+IHtcbiAgY29uc3QgZXJyb3JzID0gW107XG4gIGNvbnN0IG5hbWUgPSBnZXROYW1lKGpvYik7XG5cbiAgaWYgKCFuYW1lKSBlcnJvcnMucHVzaChuZXcgRXJyb3IoYEpvYiAjJHtpICsgMX0gaXMgbWlzc2luZyBhIG5hbWVgKSk7XG5cbiAgLy8gdGhyb3cgYW4gZXJyb3IgaWYgZHVwbGljYXRlIGpvYiBuYW1lc1xuICBpZiAocmVzZXJ2ZWROYW1lcy5pbmNsdWRlcyhuYW1lKSkge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgbmV3IEVycm9yKGBKb2IgIyR7aSArIDF9IGhhcyBhIGR1cGxpY2F0ZSBqb2IgbmFtZSBvZiAke2dldE5hbWUoam9iKX1gKVxuICAgICk7XG4gIH1cblxuICByZXR1cm4gZXJyb3JzO1xufTtcblxuY29uc3QgdmFsaWRhdGUgPSAoam9iLCBpLCBuYW1lcywgY29uZmlnKSA9PiB7XG4gIGNvbnN0IGVycm9ycyA9IHZhbGlkYXRlSm9iTmFtZShqb2IsIGksIG5hbWVzKTtcblxuICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHRocm93IGNvbWJpbmVFcnJvcnMoZXJyb3JzKTtcblxuICAvLyBzdXBwb3J0IGEgc2ltcGxlIHN0cmluZyB3aGljaCB3ZSB3aWxsIHRyYW5zZm9ybSB0byBoYXZlIGEgcGF0aFxuICBpZiAoaXNTQU5CKGpvYikpIHtcbiAgICByZXR1cm4gdmFsaWRhdGVTdHJpbmdKb2Ioam9iLCBpLCBjb25maWcpO1xuICB9XG5cbiAgLy8gam9iIGlzIGEgZnVuY3Rpb25cbiAgaWYgKHR5cGVvZiBqb2IgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gdmFsaWRhdGVGdW5jdGlvbkpvYihqb2IsIGkpO1xuICB9XG5cbiAgLy8gdXNlIGEgcHJlZml4IGZvciBlcnJvcnNcbiAgY29uc3QgcHJlZml4ID0gYEpvYiAjJHtpICsgMX0gbmFtZWQgXCIke2pvYi5uYW1lfVwiYDtcblxuICBlcnJvcnMucHVzaCguLi52YWxpZGF0ZUpvYlBhdGgoam9iLCBwcmVmaXgsIGNvbmZpZykpO1xuXG4gIC8vIGRvbid0IGFsbG93IHVzZXJzIHRvIG1peCBpbnRlcnZhbCBBTkQgY3JvblxuICBpZiAodHlwZW9mIGpvYi5pbnRlcnZhbCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGpvYi5jcm9uICE9PSAndW5kZWZpbmVkJykge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgbmV3IEVycm9yKGAke3ByZWZpeH0gY2Fubm90IGhhdmUgYm90aCBpbnRlcnZhbCBhbmQgY3JvbiBjb25maWd1cmF0aW9uYClcbiAgICApO1xuICB9XG5cbiAgLy8gZG9uJ3QgYWxsb3cgdXNlcnMgdG8gbWl4IHRpbWVvdXQgQU5EIGRhdGVcbiAgaWYgKHR5cGVvZiBqb2IudGltZW91dCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGpvYi5kYXRlICE9PSAndW5kZWZpbmVkJylcbiAgICBlcnJvcnMucHVzaChuZXcgRXJyb3IoYCR7cHJlZml4fSBjYW5ub3QgaGF2ZSBib3RoIHRpbWVvdXQgYW5kIGRhdGVgKSk7XG5cbiAgY29uc3Qgam9iTmFtZUVycm9yID0gdmFsaWRhdGVSZXNlcnZlZEpvYk5hbWUoam9iLm5hbWUpO1xuICBpZiAoam9iTmFtZUVycm9yKSBlcnJvcnMucHVzaChqb2JOYW1lRXJyb3IpO1xuXG4gIC8vIHZhbGlkYXRlIGRhdGVcbiAgaWYgKHR5cGVvZiBqb2IuZGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgIShqb2IuZGF0ZSBpbnN0YW5jZW9mIERhdGUpKVxuICAgIGVycm9ycy5wdXNoKG5ldyBFcnJvcihgJHtwcmVmaXh9IGhhZCBhbiBpbnZhbGlkIERhdGUgb2YgJHtqb2IuZGF0ZX1gKSk7XG5cbiAgWyd0aW1lb3V0JywgJ2ludGVydmFsJ10uZm9yRWFjaCgocHJvcCkgPT4ge1xuICAgIGlmICh0eXBlb2Ygam9iW3Byb3BdICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcGFyc2VWYWx1ZShqb2JbcHJvcF0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgIGNvbWJpbmVFcnJvcnMoW1xuICAgICAgICAgICAgbmV3IEVycm9yKGAke3ByZWZpeH0gaGFkIGFuIGludmFsaWQgJHtwcm9wfSBvZiAke2pvYi50aW1lb3V0fWApLFxuICAgICAgICAgICAgZXJyXG4gICAgICAgICAgXSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIC8vIHZhbGlkYXRlIGhhc1NlY29uZHNcbiAgaWYgKFxuICAgIHR5cGVvZiBqb2IuaGFzU2Vjb25kcyAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICB0eXBlb2Ygam9iLmhhc1NlY29uZHMgIT09ICdib29sZWFuJ1xuICApXG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBuZXcgRXJyb3IoXG4gICAgICAgIGAke3ByZWZpeH0gaGFkIGhhc1NlY29uZHMgdmFsdWUgb2YgJHtqb2IuaGFzU2Vjb25kc30gKGl0IG11c3QgYmUgYSBCb29sZWFuKWBcbiAgICAgIClcbiAgICApO1xuXG4gIC8vIHZhbGlkYXRlIGNyb25WYWxpZGF0ZVxuICBpZiAoXG4gICAgdHlwZW9mIGpvYi5jcm9uVmFsaWRhdGUgIT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIGpvYi5jcm9uVmFsaWRhdGUgIT09ICdvYmplY3QnXG4gIClcbiAgICBlcnJvcnMucHVzaChcbiAgICAgIG5ldyBFcnJvcihcbiAgICAgICAgYCR7cHJlZml4fSBoYWQgY3JvblZhbGlkYXRlIHZhbHVlIHNldCwgYnV0IGl0IG11c3QgYmUgYW4gT2JqZWN0YFxuICAgICAgKVxuICAgICk7XG5cbiAgaWYgKHR5cGVvZiBqb2IuY3JvbiAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBlcnJvcnMucHVzaCguLi52YWxpZGF0ZUNyb24oam9iLCBwcmVmaXgsIGNvbmZpZykpO1xuICB9XG5cbiAgLy8gdmFsaWRhdGUgY2xvc2VXb3JrZXJBZnRlck1zXG4gIGlmIChcbiAgICB0eXBlb2Ygam9iLmNsb3NlV29ya2VyQWZ0ZXJNcyAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAoIU51bWJlci5pc0Zpbml0ZShqb2IuY2xvc2VXb3JrZXJBZnRlck1zKSB8fCBqb2IuY2xvc2VXb3JrZXJBZnRlck1zIDw9IDApXG4gIClcbiAgICBlcnJvcnMucHVzaChcbiAgICAgIG5ldyBFcnJvcihcbiAgICAgICAgYCR7cHJlZml4fSBoYWQgYW4gaW52YWxpZCBjbG9zZVdvcmtlcnNBZnRlck1zIHZhbHVlIG9mICR7am9iLmNsb3NlV29ya2Vyc0FmdGVyTXN9IChpdCBtdXN0IGJlIGEgZmluaXRlIG51bWJlciA+IDApYFxuICAgICAgKVxuICAgICk7XG5cbiAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB0aHJvdyBjb21iaW5lRXJyb3JzKGVycm9ycyk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHZhbGlkYXRlO1xubW9kdWxlLmV4cG9ydHMuY3JvblZhbGlkYXRlV2l0aFNlY29uZHMgPSBjcm9uVmFsaWRhdGVXaXRoU2Vjb25kcztcbiJdfQ==